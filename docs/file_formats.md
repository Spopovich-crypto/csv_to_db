# ファイル形式ガイド

このドキュメントでは、CSV to DBツールが対応しているCSVファイル形式について詳細に説明します。

## 対応しているCSVファイル形式

CSV to DBツールは、以下の形式のCSVファイルを処理することができます：

1. **特殊形式のCSV**: センサーデータ用の特殊なヘッダー構造を持つCSVファイル
2. **ZIPファイル内のCSV**: ZIP圧縮されたアーカイブ内に含まれるCSVファイル

## 特殊形式のCSVファイル

このツールは、以下のような特殊な形式のCSVファイルを処理することができます：

### ヘッダー構造

特殊形式のCSVファイルは、以下の3行のヘッダー構造を持ちます：

1. **1行目**: センサーID（最初の列は空白、2列目以降にセンサーIDを記述）
2. **2行目**: センサー名（最初の列は空白、2列目以降にセンサー名を記述）
3. **3行目**: センサー単位（最初の列は空白、2列目以降にセンサー単位を記述）

### データ行

4行目以降は、以下の形式のデータ行となります：

- **1列目**: 時間（日時）
- **2列目以降**: 各センサーの測定値

### サンプルファイル

以下は、特殊形式のCSVファイルの例です：

```csv
,S001,S002,S003
,温度,圧力,流量
,℃,MPa,L/min
2024/04/01 10:00:00,25.3,0.5,120.5
2024/04/01 10:01:00,25.4,0.51,121.2
2024/04/01 10:02:00,25.5,0.52,122.0
```

この例では：
- `S001`, `S002`, `S003` がセンサーID
- `温度`, `圧力`, `流量` がセンサー名
- `℃`, `MPa`, `L/min` がセンサー単位
- 各行の最初の列が時間、残りの列が各センサーの測定値

## ZIPファイル内のCSVファイル

CSV to DBツールは、ZIPファイル内に含まれるCSVファイルも処理することができます。ZIPファイル内のCSVファイルも、上記の特殊形式に従っている必要があります。

### ZIPファイルの構造

ZIPファイルには、複数のCSVファイルを含めることができます。ツールは、ZIPファイル内のすべてのCSVファイルを検索し、ファイル名が`.env`ファイルの`PATTERN`設定に一致するものを処理します。

### ZIPファイル内のCSVファイルの処理

ZIPファイル内のCSVファイルは、以下のように処理されます：

1. ZIPファイルが検出されると、その中のCSVファイルが検索されます
2. ファイル名が`PATTERN`設定に一致するCSVファイルが見つかると、そのファイルが抽出され処理されます
3. 処理結果は、通常のCSVファイルと同様に、Parquetファイルとデータベースに保存されます

### ZIPファイル内のCSVファイルの識別

ZIPファイル内のCSVファイルは、ログメッセージやファイル管理において、以下の形式で識別されます：

```
<ZIPファイルのパス>::<ZIPファイル内のCSVファイルのパス>
```

例えば：

```
data/archive.zip::sensors/Cond_data.csv
```

## 横持ちデータから縦持ちデータへの変換

CSV to DBツールは、CSVファイルの「横持ち」データを「縦持ち」データに変換します。

### 横持ちデータ

横持ちデータとは、各センサーの測定値が列方向に並んでいるデータ形式です。上記のサンプルCSVファイルは横持ちデータの例です。

### 縦持ちデータ

縦持ちデータとは、各測定値が1行に1つずつ記録されるデータ形式です。横持ちデータを縦持ちデータに変換すると、以下のような形式になります：

| TIME | VALUE | PLANT | MACHINE_ID | DATA_LABEL | SENSOR_ID | SENSOR_NAME | SENSOR_UNIT | file_name |
|------|-------|-------|------------|------------|-----------|-------------|-------------|-----------|
| 2024/04/01 10:00:00 | 25.3 | AAA | No.1 | 2024 | S001 | 温度 | ℃ | sample.csv |
| 2024/04/01 10:00:00 | 0.5 | AAA | No.1 | 2024 | S002 | 圧力 | MPa | sample.csv |
| 2024/04/01 10:00:00 | 120.5 | AAA | No.1 | 2024 | S003 | 流量 | L/min | sample.csv |
| 2024/04/01 10:01:00 | 25.4 | AAA | No.1 | 2024 | S001 | 温度 | ℃ | sample.csv |
| ... | ... | ... | ... | ... | ... | ... | ... | ... |

### 変換プロセス

横持ちデータから縦持ちデータへの変換プロセスは以下の通りです：

1. CSVファイルを読み込み、ヘッダー情報（センサーID、センサー名、センサー単位）を抽出します
2. データ行を読み込み、各センサーの測定値を抽出します
3. 各センサーの測定値ごとに、時間、測定値、センサー情報、メタデータ（PLANT、MACHINE_ID、DATA_LABEL）を含む行を作成します
4. すべての行を結合して、縦持ちデータのデータフレームを作成します
5. 縦持ちデータをParquetファイルとして保存し、データベースに取り込みます

## 日時形式

CSV to DBツールは、以下の日時形式に対応しています：

- `YYYY/MM/DD HH:MM:SS`（例: `2024/04/01 10:00:00`）
- `YYYY-MM-DD HH:MM:SS`（例: `2024-04-01 10:00:00`）

日時列（TIME）は、データベースではTIMESTAMP型として保存されます。

## ファイル名パターン

処理対象のCSVファイルは、`.env`ファイルの`PATTERN`設定で指定された正規表現パターンに一致するファイル名を持つ必要があります。

例えば、`PATTERN=(Cond|User|test)`と設定した場合、以下のようなファイル名のCSVファイルが処理対象となります：

- `Cond_data.csv`
- `User_data.csv`
- `test_data.csv`
- `test_Cond_data.csv`

## テスト用ファイルの作成

テスト用のCSVファイルとZIPファイルを作成するには、プロジェクトに含まれる`create_test_zip.py`スクリプトを使用します：

```bash
python create_test_zip.py
```

このスクリプトは、以下のファイルを作成します：

- `data/test_data.csv`: テスト用のCSVファイル
- `data/test_data.zip`: テスト用のZIPファイル（内部にCSVファイルを含む）

## 次のステップ

- [ユーザーマニュアル](user_manual.md)に戻って、ツールの基本的な使い方を確認する
- [技術リファレンス](technical_reference.md)を参照して、ツールの内部動作について理解する
